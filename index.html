<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Heroes (Offline)</title>
    <!-- Подключение Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Подключение шрифта Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Иконки Ionicons -->
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .points-popup {
            position: absolute; bottom: 110%; left: 50%;
            transform: translateX(-50%); padding: 4px 12px;
            border-radius: 9999px; font-weight: bold; color: white;
            animation: floatUp 1.5s ease-out forwards;
            pointer-events: none;
        }
        @keyframes floatUp {
            from { opacity: 1; transform: translate(-50%, 0); }
            to { opacity: 0; transform: translate(-50%, -60px); }
        }
        .tab-active { background-color: #4f46e5; color: white; }
        .modal-backdrop {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex; align-items: center; justify-content: center;
            z-index: 50; animation: fadeIn 0.3s ease;
        }
        .modal-content {
            animation: fadeIn 0.3s ease, slideIn 0.4s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateY(20px) scale(0.95); }
            to { transform: translateY(0) scale(1); }
        }
    </style>
</head>
<body class="bg-slate-900 text-white flex items-center justify-center min-h-screen p-4">

    <!-- Экраны приложения -->
    <div id="loading-screen" class="text-center">
        <h1 class="text-3xl font-bold text-indigo-400">Sales Heroes</h1>
        <p class="text-slate-400 mt-2">Загрузка данных...</p>
    </div>

    <div id="create-profile-screen" class="hidden bg-slate-800 p-8 rounded-2xl shadow-2xl w-full max-w-md border border-slate-700 fade-in">
        <h1 class="text-3xl font-bold text-center mb-2 text-indigo-400">Вход или регистрация</h1>
        <p class="text-center text-slate-400 mb-6">Введите 'Admin' для входа в админ-панель</p>
        <form id="profile-form" class="space-y-4">
            <div>
                <label for="nickname" class="block mb-2 text-sm font-medium text-slate-300">Ваш никнейм</label>
                <input type="text" id="nickname" name="nickname" class="bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5" placeholder="SuperManager или Admin" required>
            </div>
            <div>
                <label for="team" class="block mb-2 text-sm font-medium text-slate-300">Выберите команду (если вы новый игрок)</label>
                <select id="team" name="team" class="bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5">
                    <option value="" disabled selected>-- Ваша команда --</option>
                    <option value="Альфа">Команда "Альфа"</option>
                    <option value="Браво">Команда "Браво"</option>
                    <option value="Чарли">Команда "Чарли"</option>
                    <option value="Дельта">Команда "Дельта"</option>
                </select>
            </div>
            <button type="submit" id="submit-button" class="w-full text-white bg-indigo-600 hover:bg-indigo-700 focus:ring-4 focus:outline-none focus:ring-indigo-500 font-medium rounded-lg text-sm px-5 py-3 text-center transition-colors duration-300">Войти / Создать</button>
        </form>
    </div>

    <div id="app-container" class="hidden w-full max-w-4xl mx-auto fade-in">
        <div class="bg-slate-800 border border-slate-700 rounded-2xl shadow-2xl p-6">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h1 id="user-nickname" class="text-3xl font-bold text-white"></h1>
                    <div class="flex items-center mt-1">
                        <p id="user-team" class="text-indigo-400 font-medium"></p>
                        <p id="user-title" class="ml-4 text-amber-400 font-semibold text-sm bg-amber-400/10 px-2 py-0.5 rounded"></p>
                    </div>
                </div>
                 <div class="flex items-center space-x-4">
                    <div class="text-right">
                         <p class="text-sm text-slate-400">Баланс</p>
                         <p id="header-balance" class="text-lg font-bold text-green-400 flex items-center">
                            <ion-icon name="cash-outline" class="mr-1"></ion-icon>
                            <span></span>
                        </p>
                    </div>
                    <button id="logout-button" class="bg-slate-700 hover:bg-red-600 hover:text-white text-slate-300 font-bold py-2 px-3 rounded-lg transition-colors">Выйти</button>
                </div>
            </div>
            <div class="mb-6">
                <div id="tabs-container" class="flex bg-slate-700 rounded-lg p-1">
                    <button id="tab-feed" class="w-full py-2 rounded-md text-sm font-medium transition-colors">Лента</button>
                    <button id="tab-dashboard" class="w-full py-2 rounded-md text-sm font-medium transition-colors">Панель</button>
                    <button id="tab-ratings" class="w-full py-2 rounded-md text-sm font-medium transition-colors">Рейтинги</button>
                    <button id="tab-shop" class="w-full py-2 rounded-md text-sm font-medium transition-colors">Магазин</button>
                    <button id="tab-admin" class="hidden w-full py-2 rounded-md text-sm font-medium transition-colors">Админ</button>
                </div>
            </div>
            <!-- Контент вкладок -->
            <div id="feed-content" class="hidden">
                 <h2 class="text-xl font-bold mb-4 text-center">Лента событий</h2>
                 <ul id="event-feed-list" class="space-y-3 max-h-[450px] overflow-y-auto pr-2"></ul>
            </div>
            <div id="dashboard-content">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8 text-center">
                    <div class="bg-slate-700/50 p-4 rounded-xl"><p class="text-sm text-slate-400">Ранг</p><p id="user-rank" class="text-2xl font-semibold text-white"></p></div>
                    <div class="bg-slate-700/50 p-4 rounded-xl"><p class="text-sm text-slate-400">Баланс</p><p id="user-balance" class="text-2xl font-semibold text-green-400"></p></div>
                    <div class="bg-slate-700/50 p-4 rounded-xl"><p class="text-sm text-slate-400">Всего очков</p><p id="user-total-points" class="text-2xl font-semibold text-white"></p></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button id="add-zalog" class="relative bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-4 rounded-lg text-lg transition-transform hover:scale-105">Закрыть Залог <span class="block text-sm opacity-80">+100 очков</span></button>
                    <button id="add-pochta" class="relative bg-sky-600 hover:bg-sky-700 text-white font-bold py-4 px-4 rounded-lg text-lg transition-transform hover:scale-105">Почтовые сборы <span class="block text-sm opacity-80">+20 очков</span></button>
                </div>
            </div>
            <div id="ratings-content" class="hidden">
                 <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div><h2 class="text-xl font-bold mb-4 text-center">Личный рейтинг</h2><ul id="personal-rating-list" class="space-y-2 max-h-96 overflow-y-auto pr-2"></ul></div>
                    <div><h2 class="text-xl font-bold mb-4 text-center">Командный рейтинг</h2><ul id="team-rating-list" class="space-y-3"></ul></div>
                 </div>
            </div>
            <div id="shop-content" class="hidden">
                <h2 class="text-xl font-bold mb-4 text-center">Магазин призов</h2>
                <div id="shop-items-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>
            <div id="admin-content" class="hidden">
                <h2 class="text-xl font-bold mb-4 text-center">Панель Администратора</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Управление магазином -->
                    <div>
                        <h3 class="text-lg font-semibold mb-3">Управление магазином</h3>
                        <div id="admin-shop-list" class="space-y-2 mb-4"></div>
                        <form id="add-item-form" class="bg-slate-700/50 p-4 rounded-lg space-y-3">
                             <h4 class="font-semibold">Добавить новый товар</h4>
                             <input type="text" id="item-name" placeholder="Название" class="bg-slate-700 border border-slate-600 text-white text-sm rounded-lg w-full p-2.5" required>
                             <input type="text" id="item-desc" placeholder="Описание" class="bg-slate-700 border border-slate-600 text-white text-sm rounded-lg w-full p-2.5" required>
                             <input type="number" id="item-price" placeholder="Цена" class="bg-slate-700 border border-slate-600 text-white text-sm rounded-lg w-full p-2.5" required>
                             <input type="text" id="item-icon" placeholder="Иконка (напр. cafe-outline)" class="bg-slate-700 border border-slate-600 text-white text-sm rounded-lg w-full p-2.5">
                             <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-lg py-2">Добавить товар</button>
                        </form>
                    </div>
                    <!-- Управление пользователями и игрой -->
                    <div>
                        <h3 class="text-lg font-semibold mb-3">Управление пользователями</h3>
                        <div id="admin-user-list" class="space-y-2 max-h-64 overflow-y-auto"></div>
                         <div class="mt-6">
                            <h3 class="text-lg font-semibold mb-3">Управление игрой</h3>
                            <button id="reset-game-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Сбросить всю игру</button>
                            <p class="text-xs text-slate-400 mt-2">ВНИМАНИЕ: Это действие удалит всех пользователей и их прогресс без возможности восстановления.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальные окна -->
    <div id="rank-up-modal" class="hidden modal-backdrop">
        <div class="modal-content bg-slate-800 border-2 border-indigo-500 rounded-2xl shadow-2xl p-8 w-full max-w-sm text-center">
            <h2 class="text-2xl font-bold text-amber-400 mb-2">НОВЫЙ РАНГ!</h2>
            <p class="text-slate-300 mb-4">Вы достигли ранга:</p>
            <p id="new-rank-name" class="text-4xl font-bold text-white bg-indigo-600 rounded-lg py-3 mb-6"></p>
            <button id="close-rank-modal" class="w-full bg-slate-600 hover:bg-slate-700 text-white font-medium rounded-lg py-2.5">Продолжить</button>
        </div>
    </div>
    <div id="achievement-unlocked-modal" class="hidden modal-backdrop">
        <div class="modal-content bg-slate-800 border-2 border-amber-500 rounded-2xl shadow-2xl p-8 w-full max-w-sm text-center">
            <h2 class="text-2xl font-bold text-amber-400 mb-2">ДОСТИЖЕНИЕ РАЗБЛОКИРОВАНО!</h2>
            <p id="achievement-name" class="text-3xl font-bold text-white mb-2"></p>
            <p id="achievement-desc" class="text-slate-300 mb-6"></p>
            <button id="close-achievement-modal" class="w-full bg-slate-600 hover:bg-slate-700 text-white font-medium rounded-lg py-2.5">Отлично!</button>
        </div>
    </div>
    <div id="purchase-confirm-modal" class="hidden modal-backdrop">
        <div class="modal-content bg-slate-800 border-slate-700 rounded-2xl shadow-2xl p-8 w-full max-w-sm text-center">
            <h2 class="text-xl font-bold text-white mb-2">Подтверждение покупки</h2>
            <p id="purchase-confirm-text" class="text-slate-300 mb-6"></p>
            <div class="flex justify-between gap-4">
                <button id="cancel-purchase-btn" class="w-full bg-slate-600 hover:bg-slate-700 text-white font-medium rounded-lg py-2.5">Отмена</button>
                <button id="confirm-purchase-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg py-2.5">Купить</button>
            </div>
        </div>
    </div>
    <div id="alert-modal" class="hidden modal-backdrop">
        <div class="modal-content bg-slate-800 border-slate-700 rounded-2xl shadow-2xl p-8 w-full max-w-sm text-center">
             <p id="alert-modal-text" class="text-white text-lg mb-6"></p>
             <button id="close-alert-modal" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-lg py-2.5">Понятно</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const dom = Object.fromEntries(['loading-screen', 'create-profile-screen', 'app-container', 'profile-form', 'logout-button', 'add-zalog', 'add-pochta', 'tabs-container', 'tab-feed', 'tab-dashboard', 'tab-ratings', 'tab-shop', 'tab-admin', 'feed-content', 'dashboard-content', 'ratings-content', 'shop-content', 'admin-content', 'rank-up-modal', 'close-rank-modal', 'new-rank-name', 'purchase-confirm-modal', 'purchase-confirm-text', 'cancel-purchase-btn', 'confirm-purchase-btn', 'alert-modal', 'alert-modal-text', 'close-alert-modal', 'user-nickname', 'user-team', 'header-balance', 'user-rank', 'user-balance', 'user-total-points', 'personal-rating-list', 'team-rating-list', 'shop-items-grid', 'admin-shop-list', 'add-item-form', 'admin-user-list', 'reset-game-btn', 'user-title', 'achievement-unlocked-modal', 'achievement-name', 'achievement-desc', 'close-achievement-modal', 'event-feed-list'].map(id => [id.replace(/-/g, ''), document.getElementById(id)]));

            const RANKS = [
                { name: "Новичок", points: 0 }, { name: "Специалист", points: 1000 }, { name: "Эксперт", points: 5000 },
                { name: "Мастер", points: 15000 }, { name: "Легенда продаж", points: 30000 }
            ];

            const ACHIEVEMENTS = {
                ZALOG_KING: { name: "Король Залогов", description: "Закройте 10 залогов.", condition: (user) => user.zalogCount >= 10 },
                POCHTA_MASTER: { name: "Мастер Сборов", description: "Закройте 50 почтовых сборов.", condition: (user) => user.pochtaCount >= 50 },
                SHOPAHOLIC: { name: "Коллекционер", description: "Совершите 3 покупки в магазине.", condition: (user, purchases) => purchases[user.uid]?.length >= 3 },
                SPRINTER: { name: "Спринтер", description: "Первым наберите 1000 очков.", condition: (user, purchases, globalState) => user.totalPoints >= 1000 && !globalState.sprinterAwarded }
            };

            const INITIAL_SHOP_ITEMS = [
                { id: 'item1', name: "Фирменная кружка", description: "Для самого вкусного кофе.", price: 500, icon: "cafe-outline" },
                { id: 'item2', name: "Билет в кино", description: "На любой фильм в любое время.", price: 1500, icon: "film-outline" },
                { id: 'item3', name: "Пицца для отдела", description: "Разделите радость с коллегами.", price: 3000, icon: "pizza-outline" },
                { id: 'item4', name: "Дополнительный выходной", description: "Заслуженный отдых.", price: 10000, icon: "sunny-outline" },
                { id: 'item5', name: "Сертификат в ресторан", description: "На романтический ужин.", price: 7500, icon: "restaurant-outline"},
                { id: 'item6', name: "Наушники", description: "Для работы и отдыха.", price: 12000, icon: "headset-outline"}
            ];

            let state = {
                currentUserUid: null,
                users: {},
                shopItems: [],
                purchases: {},
                global: {},
                eventLog: []
            };

            function loadState() {
                state.currentUserUid = localStorage.getItem('salesGameCurrentUserUid');
                state.users = JSON.parse(localStorage.getItem('salesGameUsers')) || {};
                state.shopItems = JSON.parse(localStorage.getItem('salesGameShopItems')) || INITIAL_SHOP_ITEMS;
                state.purchases = JSON.parse(localStorage.getItem('salesGamePurchases')) || {};
                state.global = JSON.parse(localStorage.getItem('salesGameGlobal')) || { sprinterAwarded: false };
                state.eventLog = JSON.parse(localStorage.getItem('salesGameEventLog')) || [];
                
                const adminExists = Object.values(state.users).some(u => u.isAdmin);
                if (!adminExists) {
                    const adminId = 'admin-user-001';
                    state.users[adminId] = {
                        uid: adminId, nickname: 'Admin', team: 'Администрация',
                        totalPoints: 99999, rank: "Всемогущий", balance: 99999,
                        zalogCount: 0, pochtaCount: 0, createdAt: new Date().toISOString(),
                        isAdmin: true, unlockedAchievements: [], equippedTitle: null
                    };
                }

                if (!localStorage.getItem('salesGameShopItems')) {
                    saveState();
                }
            }

            function saveState() {
                localStorage.setItem('salesGameCurrentUserUid', state.currentUserUid);
                localStorage.setItem('salesGameUsers', JSON.stringify(state.users));
                localStorage.setItem('salesGameShopItems', JSON.stringify(state.shopItems));
                localStorage.setItem('salesGamePurchases', JSON.stringify(state.purchases));
                localStorage.setItem('salesGameGlobal', JSON.stringify(state.global));
                localStorage.setItem('salesGameEventLog', JSON.stringify(state.eventLog));
            }

            function addLogEntry(message, icon) {
                state.eventLog.unshift({
                    message,
                    icon,
                    timestamp: new Date().toISOString(),
                    id: crypto.randomUUID()
                });
                if (state.eventLog.length > 50) { // Ограничиваем лог
                    state.eventLog.pop();
                }
            }
            
            function updateUI() {
                if (!state.currentUserUid || !state.users[state.currentUserUid]) {
                    showCreateProfileScreen();
                    return;
                }

                const user = state.users[state.currentUserUid];
                
                checkAchievements(user);

                dom.tabadmin.classList.toggle('hidden', !user.isAdmin);
                
                const oldRank = user.rank;
                const newRank = getRankForPoints(user.totalPoints);
                if (newRank !== oldRank && !user.isAdmin) {
                    user.rank = newRank;
                    addLogEntry(`**${user.nickname}** достиг ранга **${newRank}**!`, 'ribbon-outline');
                    showRankUpModal(newRank);
                }

                const balanceFormatted = user.balance.toLocaleString('ru-RU');
                dom.usernickname.textContent = user.nickname;
                dom.userteam.textContent = `Команда "${user.team}"`;
                dom.usertitle.textContent = user.equippedTitle || '';
                dom.usertitle.classList.toggle('hidden', !user.equippedTitle);
                dom.headerbalance.querySelector('span').textContent = balanceFormatted;
                dom.userrank.textContent = user.rank;
                dom.userbalance.textContent = balanceFormatted;
                dom.usertotalpoints.textContent = user.totalPoints.toLocaleString('ru-RU');
                
                renderEventFeed();
                updateRatingsUI();
                renderShopItems();
                renderAdminPanel();
                
                showAppContainer();
                saveState();
            }

            function handleLoginOrCreate(e) {
                e.preventDefault();
                const nicknameInput = dom.profileform.nickname;
                const teamInput = dom.profileform.team;
                const nickname = nicknameInput.value.trim();

                if (nickname.toLowerCase() === 'admin') {
                    const adminUser = Object.values(state.users).find(u => u.isAdmin);
                    if (adminUser) {
                        state.currentUserUid = adminUser.uid;
                        updateUI();
                        dom.profileform.reset();
                    }
                    return;
                }

                const team = teamInput.value;
                if (!nickname || !team) {
                    showAlert("Пожалуйста, заполните никнейм и выберите команду.");
                    return;
                }

                const uid = crypto.randomUUID();
                state.users[uid] = {
                    uid, nickname, team,
                    totalPoints: 0, rank: "Новичок", balance: 0,
                    zalogCount: 0, pochtaCount: 0,
                    createdAt: new Date().toISOString(),
                    isAdmin: false, unlockedAchievements: [], equippedTitle: null
                };
                state.currentUserUid = uid;
                state.purchases[uid] = [];
                addLogEntry(`Новый игрок в команде! **${nickname}** присоединился к нам.`, 'person-add-outline');
                updateUI();
                dom.profileform.reset();
            }

            function addPoints(points, counterField) {
                const user = state.users[state.currentUserUid];
                if (!user || user.isAdmin) return;
                user.balance += points;
                user.totalPoints += points;
                user[counterField] += 1;
                
                if (points === 100) {
                    addLogEntry(`**${user.nickname}** закрыл **Залог** (+100 очков).`, 'shield-checkmark-outline');
                } else if (points === 20) {
                    addLogEntry(`**${user.nickname}** обработал **Почтовые сборы** (+20 очков).`, 'mail-outline');
                }

                updateUI();
            }
            
            function handlePurchase(item) {
                const user = state.users[state.currentUserUid];
                if (!user || user.balance < item.price) { return showAlert("Недостаточно средств!"); }
                dom.purchaseconfirmmodal.classList.add('hidden');
                user.balance -= item.price;
                if (!state.purchases[state.currentUserUid]) { state.purchases[state.currentUserUid] = []; }
                state.purchases[state.currentUserUid].push({ itemId: item.id, itemName: item.name, price: item.price, purchasedAt: new Date().toISOString() });
                addLogEntry(`**${user.nickname}** купил **${item.name}** в магазине.`, 'bag-handle-outline');
                showAlert(`Поздравляем! Вы приобрели "${item.name}".`);
                updateUI();
            }

            function logout() {
                state.currentUserUid = null;
                localStorage.removeItem('salesGameCurrentUserUid');
                showCreateProfileScreen();
            }
            
            function checkAchievements(user) {
                if (user.isAdmin) return;
                for (const key in ACHIEVEMENTS) {
                    const achievement = ACHIEVEMENTS[key];
                    if (!user.unlockedAchievements.includes(key) && achievement.condition(user, state.purchases, state.global)) {
                        user.unlockedAchievements.push(key);
                        user.equippedTitle = achievement.name;
                        if(key === 'SPRINTER') {
                            state.global.sprinterAwarded = true;
                        }
                        addLogEntry(`**${user.nickname}** получил достижение: **${achievement.name}**!`, 'star-outline');
                        showAchievementUnlockedModal(achievement);
                    }
                }
            }

            function renderEventFeed() {
                dom.eventfeedlist.innerHTML = '';
                state.eventLog.forEach(log => {
                    const timeAgo = formatTimeAgo(log.timestamp);
                    const messageHTML = log.message.replace(/\*\*(.*?)\*\*/g, '<strong class="text-indigo-400 font-semibold">$1</strong>');
                    dom.eventfeedlist.innerHTML += `
                        <li class="flex items-start p-3 bg-slate-700/50 rounded-lg">
                            <ion-icon name="${log.icon}" class="text-xl text-slate-400 mr-4 mt-1"></ion-icon>
                            <div class="flex-1">
                                <p class="text-white">${messageHTML}</p>
                                <p class="text-xs text-slate-500 mt-1">${timeAgo}</p>
                            </div>
                        </li>
                    `;
                });
            }

            function formatTimeAgo(dateString) {
                const now = new Date();
                const past = new Date(dateString);
                const seconds = Math.floor((now - past) / 1000);

                let interval = seconds / 31536000;
                if (interval > 1) return Math.floor(interval) + " г. назад";
                interval = seconds / 2592000;
                if (interval > 1) return Math.floor(interval) + " мес. назад";
                interval = seconds / 86400;
                if (interval > 1) return Math.floor(interval) + " д. назад";
                interval = seconds / 3600;
                if (interval > 1) return Math.floor(interval) + " ч. назад";
                interval = seconds / 60;
                if (interval > 1) return Math.floor(interval) + " мин. назад";
                return "Только что";
            }
            
            function handleAddItem(e) {
                e.preventDefault();
                const form = dom.additemform;
                const name = form.querySelector('#item-name').value;
                if (name) {
                    addLogEntry(`Администратор добавил новый товар: **${name}**`, 'add-circle-outline');
                }
                const description = form.querySelector('#item-desc').value;
                const price = parseInt(form.querySelector('#item-price').value);
                const icon = form.querySelector('#item-icon').value;
                if (name && description && price > 0) {
                    state.shopItems.push({ id: 'item' + Date.now(), name, description, price, icon });
                    form.reset();
                    updateUI();
                }
            }
            
            function handleResetGame() {
                if (confirm("Вы уверены, что хотите сбросить всю игру? Это действие необратимо!")) {
                    addLogEntry(`**Администратор** полностью перезапустил игру!`, 'alert-circle-outline');
                    saveState(); // Сохраняем последнее событие перед сбросом
                    localStorage.removeItem('salesGameCurrentUserUid');
                    localStorage.removeItem('salesGameUsers');
                    localStorage.removeItem('salesGameShopItems');
                    localStorage.removeItem('salesGamePurchases');
                    localStorage.removeItem('salesGameGlobal');
                    localStorage.removeItem('salesGameEventLog');
                    state.currentUserUid = null; state.users = {}; state.shopItems = []; state.purchases = {}; state.global = {}; state.eventLog = [];
                    loadState();
                    updateUI();
                }
            }

            function getRankForPoints(points) { return RANKS.slice().reverse().find(r => points >= r.points)?.name || RANKS[0].name; }
            function updateRatingsUI() { const allUsers = Object.values(state.users).filter(u => !u.isAdmin); allUsers.sort((a,b) => b.totalPoints - a.totalPoints); dom.personalratinglist.innerHTML = ''; allUsers.forEach((user, index) => { const isCurrentUser = user.uid === state.currentUserUid; dom.personalratinglist.innerHTML += `<li class="flex items-center justify-between p-3 rounded-lg ${isCurrentUser ? 'bg-indigo-600' : 'bg-slate-700'}"><div class="flex items-center"><span class="text-sm font-bold w-6 text-center mr-3">${index + 1}</span><div><p class="font-semibold">${user.nickname}</p><p class="text-xs text-slate-400">Команда "${user.team}"</p></div></div><span class="font-bold text-lg">${user.totalPoints.toLocaleString('ru-RU')}</span></li>`; }); const teamScores = allUsers.reduce((acc, user) => { acc[user.team] = (acc[user.team] || 0) + user.totalPoints; return acc; }, {}); const sortedTeams = Object.entries(teamScores).map(([name, score]) => ({ name, score })).sort((a, b) => b.score - a.score); dom.teamratinglist.innerHTML = ''; sortedTeams.forEach((team, index) => { dom.teamratinglist.innerHTML += `<li class="bg-slate-700 p-4 rounded-lg flex items-center justify-between"><div class="flex items-center"><span class="text-lg font-bold w-8 text-center mr-4">${index + 1}</span><p class="font-bold text-xl">${team.name}</p></div><span class="font-bold text-2xl text-indigo-400">${team.score.toLocaleString('ru-RU')}</span></li>`; }); }
            function renderShopItems() { const user = state.users[state.currentUserUid]; if (!user) return; dom.shopitemsgrid.innerHTML = ''; state.shopItems.sort((a,b) => a.price - b.price).forEach(item => { const canAfford = user.balance >= item.price; const buttonClasses = canAfford ? 'bg-indigo-600 hover:bg-indigo-700' : 'bg-slate-500 cursor-not-allowed'; dom.shopitemsgrid.innerHTML += `<div class="bg-slate-700/50 rounded-xl p-4 flex flex-col"><div class="w-full h-32 bg-slate-600 rounded-lg flex items-center justify-center mb-4"><ion-icon name="${item.icon || 'storefront-outline'}" class="text-5xl text-slate-400"></ion-icon></div><h3 class="font-bold text-lg text-white">${item.name}</h3><p class="text-sm text-slate-400 mb-4 flex-grow">${item.description}</p><div class="flex justify-between items-center"><span class="font-bold text-lg text-green-400">${item.price.toLocaleString()}</span><button class="buy-btn text-white font-semibold py-2 px-4 rounded-lg text-sm transition-colors ${buttonClasses}" data-item-id="${item.id}" ${!canAfford ? 'disabled' : ''}>Купить</button></div></div>`; }); document.querySelectorAll('.buy-btn').forEach(btn => btn.addEventListener('click', (e) => { const item = state.shopItems.find(i => i.id === e.target.dataset.itemId); if (item) openPurchaseConfirmModal(item); })); }
            function openPurchaseConfirmModal(item) { dom.purchaseconfirmtext.textContent = `Вы уверены, что хотите купить "${item.name}" за ${item.price.toLocaleString()} очков?`; dom.confirmpurchasebtn.onclick = () => handlePurchase(item); dom.purchaseconfirmmodal.classList.remove('hidden'); }
            function showAlert(message) { dom.alertmodaltext.textContent = message; dom.alertmodal.classList.remove('hidden'); }
            function showRankUpModal(newRank) { dom.newrankname.textContent = newRank; dom.rankupmodal.classList.remove('hidden'); }
            function showAchievementUnlockedModal(achievement) { dom.achievementname.textContent = achievement.name; dom.achievementdesc.textContent = achievement.description; dom.achievementunlockedmodal.classList.remove('hidden'); }
            
            function switchTab(tab) {
                ['feed', 'dashboard', 'ratings', 'shop', 'admin'].forEach(t => {
                    dom[`${t}content`]?.classList.add('hidden');
                    dom[`tab${t}`]?.classList.remove('tab-active');
                });
                dom[`${tab}content`]?.classList.remove('hidden');
                dom[`tab${tab}`]?.classList.add('tab-active');
            }
            function showLoadingScreen() { dom.loadingscreen.classList.remove('hidden'); dom.createprofilescreen.classList.add('hidden'); dom.appcontainer.classList.add('hidden'); }
            function showCreateProfileScreen() { dom.loadingscreen.classList.add('hidden'); dom.createprofilescreen.classList.remove('hidden'); dom.appcontainer.classList.add('hidden'); }
            function showAppContainer() { dom.loadingscreen.classList.add('hidden'); dom.createprofilescreen.classList.add('hidden'); dom.appcontainer.classList.remove('hidden'); if (!dom.tabdashboard.classList.contains('tab-active') && !dom.tabratings.classList.contains('tab-active') && !dom.tabshop.classList.contains('tab-active') && !dom.tabadmin.classList.contains('tab-active') && !dom.tabfeed.classList.contains('tab-active')) { switchTab('feed'); } }
            
            dom.profileform.addEventListener('submit', handleLoginOrCreate);
            dom.logoutbutton.addEventListener('click', logout);
            dom.addzalog.addEventListener('click', () => addPoints(100, 'zalogCount'));
            dom.addpochta.addEventListener('click', () => addPoints(20, 'pochtaCount'));
            ['feed', 'dashboard', 'ratings', 'shop', 'admin'].forEach(tabId => dom[`tab${tabId}`]?.addEventListener('click', () => switchTab(tabId)));
            dom.closerankmodal.addEventListener('click', () => dom.rankupmodal.classList.add('hidden'));
            dom.closeachievementmodal.addEventListener('click', () => dom.achievementunlockedmodal.classList.add('hidden'));
            dom.cancelpurchasebtn.addEventListener('click', () => dom.purchaseconfirmmodal.classList.add('hidden'));
            dom.closealertmodal.addEventListener('click', () => dom.alertmodal.classList.add('hidden'));
            dom.additemform.addEventListener('submit', handleAddItem);
            dom.resetgamebtn.addEventListener('click', handleResetGame);
            dom.adminshoplist.addEventListener('click', (e) => { if (e.target.classList.contains('admin-delete-item')) { handleDeleteItem(e.target.dataset.id); } });
            dom.adminuserlist.addEventListener('click', (e) => { if(e.target.classList.contains('admin-delete-user')) { handleDeleteUser(e.target.dataset.id); } });

            function renderAdminPanel() { dom.adminshoplist.innerHTML = ''; state.shopItems.forEach(item => { dom.adminshoplist.innerHTML += `<div class="bg-slate-700 p-2 rounded-md flex justify-between items-center text-sm"><span>${item.name} - ${item.price} очков</span><button class="admin-delete-item text-red-400 hover:text-red-600" data-id="${item.id}">Удалить</button></div>`; }); dom.adminuserlist.innerHTML = ''; Object.values(state.users).filter(u => !u.isAdmin).forEach(user => { dom.adminuserlist.innerHTML += `<div class="bg-slate-700 p-2 rounded-md flex justify-between items-center text-sm"><span>${user.nickname} (${user.team})</span><button class="admin-delete-user text-red-400 hover:text-red-600" data-id="${user.uid}">Удалить</button></div>`; }); }
            function handleDeleteItem(id) { state.shopItems = state.shopItems.filter(item => item.id !== id); updateUI(); }
            function handleDeleteUser(id) { delete state.users[id]; delete state.purchases[id]; updateUI(); }

            loadState();
            updateUI();
        });
    </script>
</body>
</html>
